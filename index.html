<!DOCTYPE html>
<html>
  <head>
    <title>Climb The World Online</title>
    <meta charset="utf-8">
    <meta name="viewport"
          content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <link rel="stylesheet" href="https://openlayers.org/en/v4.6.5/css/ol.css" type="text/css">
    <!-- The line below is only needed for old environments like Internet Explorer and Android 4.x -->
    <script src="https://cdn.polyfill.io/v2/polyfill.min.js?features=requestAnimationFrame,Element.prototype.classList,URL"></script>
    <script src="https://code.jquery.com/jquery-2.2.3.min.js"></script>
    <script src="https://openlayers.org/en/v4.6.5/build/ol.js"></script>
    <script src="https://rawgit.com/tyrasd/osmtogeojson/gh-pages/osmtogeojson.js"></script>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>

    <style>
        html, body, .fullscreen, .map {
        margin: 0;
        padding: 0;
        width: 100%;
        height: 100%;
      }

      .popover
      {
        min-width: 20ch ! important;
        max-width: 100%;
      }

      #zoomWorning {
        position:fixed;
        top: 50%;
        left: 50%;
        width:16em;
        height:2em;
        margin-top: 0em; /*set to a negative number 1/2 of your height*/
        margin-left: -8em; /*set to a negative number 1/2 of your width*/
        display: table-cell;
        border: 1px solid #ccc;
        background-color: #f3f3f3;
      }
      P { 
        text-align: center;
        vertical-align: middle;
        }
      </style>
  </head>
  <body>
    <div id="fullscreen" class="fullscreen">
        <div id="map" class="map">
          <div id="popup" class="popup"></div>
          
        </div>
        <div id="zoomWorning"><p>Zoom in to view data.</p></div>
    </div>


    <script>
      var MAX_ZOOM_LEVEL = 9;
      var uiaaGrades = ["1-","1","1+","2-","2","2+","3-","3","3+","4-","4","4+","5-","5","5+","6-","6","6+","7-","7","7+","8-","8","8+","9-","9","9+","10-","10","10+","11-","11","11+","12+","12","12+","13-","13","13+","14-"];

      var zoomDialog = document.getElementById('zoomWorning');
      zoomDialog.style.display = 'none';

      var styles = {
          'crag': [new ol.style.Style({
            image: new ol.style.Icon(/** @type {olx.style.IconOptions} */ ({
                anchor: [0.5, 1],
                width: 6,
                color: '#ffffffaa',
                src: './res/img/ic_poi_crag.svg'
              }))
          })],
          'gym': [new ol.style.Style({
            image: new ol.style.Icon(/** @type {olx.style.IconOptions} */ ({
                anchor: [0.5, 1],
                width: 6,
                color: '#ffffffaa',
                src: './res/img/ic_poi_gym.svg'
              }))
          })],
          'route?': [new ol.style.Style({
            image: new ol.style.Icon(/** @type {olx.style.IconOptions} */ ({
                anchor: [0.5, 1],
                width: 6,
                color: '#00ff00aa',
                src: './res/img/ic_route.svg'
              }))
          })],
          'undefined': [new ol.style.Style({
            image: new ol.style.Icon(/** @type {olx.style.IconOptions} */ ({
                anchor: [0.5, 1],
                width: 6,
                color: '#ffffffaa',
                src: './res/img/ic_route.svg'
              }))
          })]
      };

      function remapScale(orgMin, orgMax, newMin, newMax, pos) {
        var result = newMax;

        var oldRange = (orgMax - orgMin);
        if (oldRange != 0)
        {
            result = ((pos - orgMin) * (newMax - newMin) / oldRange) + newMin;
        }

        return result;
      }

      function mix(a, b, v)
      {
          return (1-v)*a + v*b;
      }

      function HSVtoRGB(H, S, V)
      {
          var V2 = V * (1 - S);
          var r  = ((H>=0 && H<=60) || (H>=300 && H<=360)) ? V : ((H>=120 && H<=240) ? V2 : ((H>=60 && H<=120) ? mix(V,V2,(H-60)/60) : ((H>=240 && H<=300) ? mix(V2,V,(H-240)/60) : 0)));
          var g  = (H>=60 && H<=180) ? V : ((H>=240 && H<=360) ? V2 : ((H>=0 && H<=60) ? mix(V2,V,H/60) : ((H>=180 && H<=240) ? mix(V,V2,(H-180)/60) : 0)));
          var b  = (H>=0 && H<=120) ? V2 : ((H>=180 && H<=300) ? V : ((H>=120 && H<=180) ? mix(V2,V,(H-120)/60) : ((H>=300 && H<=360) ? mix(V,V2,(H-300)/60) : 0)));

          return {
              r : Math.round(r * 255),
              g : Math.round(g * 255),
              b : Math.round(b * 255)
          };
      }

      function rgbToHex(color) {
        return "#" + ((1 << 24) + (color.r << 16) + (color.g << 8) + color.b).toString(16).slice(1);
      }

      function getFeatureType(feature) {
        if (feature.get('climbing') === 'crag') {
          return 'crag';
        } else if(feature.get('leisure') === 'sports_centre' || feature.get('tower:type') === 'climbing') {
          return 'gym';
        } else if ((feature.get('climbing') === 'route_bottom' || feature.get('climbing') === 'route_top')) {
          return 'route';
        } else {
          return 'undefined';
        }
      }

      var styleFunction = function (feature, resolution) {
          var featureType = getFeatureType(feature);
          if (featureType === 'crag') {
            return styles['crag'];
          } else if(featureType === 'gym') {
            return styles['gym'];
          } else if (featureType === 'route') {
            var grade = '?';
            if (feature.get('climbing:grade:uiaa')) {
              grade = feature.get('climbing:grade:uiaa');
            }

            if (!styles['route'+grade]) {
              styles['route'+grade] =[new ol.style.Style({
                  image: new ol.style.Icon(/** @type {olx.style.IconOptions} */ ({
                      anchor: [0.5, 1],
                      width: 6,
                      color: rgbToHex(HSVtoRGB(remapScale(0, uiaaGrades.length-1, 1, 0, uiaaGrades.indexOf(grade))*120, 1, 1)),
                      src: './res/img/ic_route.svg'
                    }))
                })]
            }

            return styles['route'+grade];
          } else {
            return styles['undefined'];
          }
      };

      var contentFunction = function (feature) {
        var featureType = getFeatureType(feature);
        var resultContent ="";
        var resultTitle = feature.get('name') + ' [' + featureType + ']';
        if (feature.get('climbing:grade:uiaa')) {
          resultContent = resultContent + '<b>Uiaa grade:</b> ' + feature.get('climbing:grade:uiaa') + '<br/>';
        }
        if (feature.get('contact:website')) {
          resultContent = resultContent + '<b>Contact website:</b> <a target="blank" href="' + feature.get('contact:website') + '">' + feature.get('contact:website') +'</a><br/>';
        } else if (feature.get('website')) {
          resultContent = resultContent + '<b>Website:</b> <a target="blank" href="' + feature.get('website') + '">' + feature.get('website') +'</a><br/>'
        }
        resultContent = resultContent + '<b>Open in OSM:</b> <a target="blank" href="https://www.openstreetmap.org/' + feature.get('id') + '">' + feature.get('id') +'</a><br/>'
        return {
          title: resultTitle,
          content: resultContent
        };
      };

      var map = new ol.Map({
        layers: [
          new ol.layer.Tile({
            source: new ol.source.OSM()
          })
        ],
        target: 'map',
        view: new ol.View({
          center: ol.proj.fromLonLat([-73.554, 45.5088]),
          zoom: 13
        })
      });
      
      map.getView().on('change:resolution', function(evt){
        if (map.getView().getZoom() < MAX_ZOOM_LEVEL) {
          vectorSource.clear();
          zoomDialog.style.display = 'block';
        } else {
          zoomDialog.style.display = 'none';
        }

        if (element) {
          $(element).popover('destroy');
        }
      });

      var vectorSource = new ol.source.Vector({
        format: new ol.format.GeoJSON(),
        loader: function(extent, resolution, projection) {
          if (map.getView().getZoom() < MAX_ZOOM_LEVEL) {
            return;
          }
          var epsg4326Extent =
              ol.proj.transformExtent(extent, projection, 'EPSG:4326');
          var stringExtent = epsg4326Extent[1] + ',' + epsg4326Extent[0] + ',' +
              epsg4326Extent[3] + ',' + epsg4326Extent[2];

          var query = '[bbox:'+ stringExtent + '][out:json][timeout:60];(node["sport"="climbing"];);out center;>;'
          fetch('https://overpass.kumi.systems/api/interpreter', {
            method: "POST",
            body: query
          })
          .then(response => response.json())
          .then(json => {
            const geojson = osmtogeojson(json, {
              flatProperties: true
            });
            var features = new ol.format.GeoJSON().readFeatures(geojson, {
              featureProjection: map.getView().getProjection()
            });
            if (map.getView().getZoom() >= MAX_ZOOM_LEVEL) {
              vectorSource.addFeatures(features);
            }
          });
        },
        strategy: ol.loadingstrategy.bbox
        // strategy: ol.loadingstrategy.all 
      });

      var vectorLayer = new ol.layer.Vector({
        renderMode: 'image',
        source: vectorSource,
        style: styleFunction
      })
      map.addLayer(vectorLayer);

      var popup = new ol.Overlay({
        element: document.getElementById('popup'),
        positioning: 'bottom-center',
        offset: [0, -50]
      });
      map.addOverlay(popup);

      var element;

      map.on('click', function(evt) {
        var feature = map.forEachFeatureAtPixel(evt.pixel,
            function(feature) {
              return feature;
            });
        if (feature) {
          var contentData = contentFunction(feature)
          var coordinates = feature.getGeometry().getCoordinates();
          element = popup.getElement();

          $(element).popover('destroy');
          popup.setPosition(coordinates);
          $(element).popover({
            animation: false,
            placement: 'top',
            html: true,
            container: 'body',
            title: contentData.title,
            content: contentData.content
          });
          $(element).popover('show');
        } else {
          $(element).popover('destroy');
        }
      });

      map.on('pointermove', function(evt) {
        if (evt.dragging) {
          if (element) {
            $(element).popover('destroy');
          }
          return;
        }
        map.getTargetElement().style.cursor =
            map.hasFeatureAtPixel(evt.pixel) ? 'pointer' : '';
      });

    </script>
  </body>
</html>
